- id: MCP-01
  description: Returns basic session state
  category: mcp-tools
  status: implemented
  priority: P0
  when: mcp_jules_session_state
  given:
    sessionId: session-123
    sessionResource:
      id: session-123
      state: inProgress
      url: http://example.com/session-123
      title: Test Session
  then:
    result:
      id: session-123
      state: inProgress
      url: http://example.com/session-123
      title: Test Session
- id: MCP-02
  description: Includes PR info when available
  category: mcp-tools
  status: implemented
  priority: P1
  when: mcp_jules_session_state
  given:
    sessionId: session-123
    sessionResource:
      id: session-123
      state: succeeded
      url: http://example.com/session-123
      title: Test Session with PR
      outputs:
        - type: pullRequest
          pullRequest:
            url: http://github.com/pr/1
            title: 'Feat: New feature'
  then:
    result:
      id: session-123
      state: succeeded
      pr:
        url: http://github.com/pr/1
        title: 'Feat: New feature'
- id: MCP-03
  description: Handles sessions with no PR info gracefully
  category: mcp-tools
  status: implemented
  priority: P1
  when: mcp_jules_session_state
  given:
    sessionId: session-456
    sessionResource:
      id: session-456
      state: failed
      url: http://example.com/session-456
      title: Failed Session
      outputs: []
  then:
    result:
      id: session-456
      state: failed
      pr: null
- id: MCP-04
  description: Returns the first page of activities
  category: mcp-tools
  status: implemented
  priority: P0
  when: mcp_jules_session_timeline
  given:
    sessionId: session-abc
    args:
      limit: 2
    activities:
      - id: act-1
        type: agentMessaged
        message: Hello
      - id: act-2
        type: planGenerated
        plan:
          steps: []
      - id: act-3
        type: userMessaged
        message: Hi
  then:
    result:
      activities:
        count: 2
        items:
          - id: act-1
          - id: act-2
      hasMore: true
      nextCursor: act-2
- id: MCP-05
  description: Returns the next page of activities using a cursor
  category: mcp-tools
  status: implemented
  priority: P1
  when: mcp_jules_session_timeline
  given:
    sessionId: session-abc
    args:
      limit: 2
      startAfter: act-2
    activities:
      - id: act-3
        type: userMessaged
        message: Hi
  then:
    result:
      activities:
        count: 1
        items:
          - id: act-3
      hasMore: false
      nextCursor: null
- id: MCP-06
  description: Returns the last page of activities correctly
  category: mcp-tools
  status: implemented
  priority: P1
  when: mcp_jules_session_timeline
  given:
    sessionId: session-def
    args:
      limit: 5
    activities:
      - id: act-1
      - id: act-2
  then:
    result:
      activities:
        count: 2
      hasMore: false
      nextCursor: null
- id: MCP-07
  description: Respects the default limit of 10
  category: mcp-tools
  status: implemented
  priority: P2
  when: mcp_jules_session_timeline
  given:
    sessionId: session-ghi
    args: {}
    activities:
      - { id: 1 }
      - { id: 2 }
      - { id: 3 }
      - { id: 4 }
      - { id: 5 }
      - { id: 6 }
      - { id: 7 }
      - { id: 8 }
      - { id: 9 }
      - { id: 10 }
      - { id: 11 }
  then:
    result:
      activities:
        count: 10
      hasMore: true
      nextCursor: 10
- id: MCP-08
  description: Sorts activities in ascending order
  category: mcp-tools
  status: implemented
  priority: P2
  when: mcp_jules_session_timeline
  given:
    sessionId: session-jkl
    args:
      order: asc
      limit: 2
    activities:
      - id: act-z
      - id: act-y
      - id: act-x
  then:
    result:
      activities:
        count: 2
        items:
          - id: act-z
          - id: act-y
      hasMore: true
      nextCursor: act-y
- id: MCP-09
  description: Filters activities by type with pagination
  category: mcp-tools
  status: implemented
  priority: P1
  when: mcp_jules_session_timeline
  given:
    sessionId: session-mno
    args:
      type: agentMessaged
      limit: 1
    activities:
      - id: act-1
        type: agentMessaged
      - id: act-2
        type: planGenerated
      - id: act-3
        type: agentMessaged
  then:
    result:
      activities:
        count: 1
        items:
          - id: act-1
      hasMore: true
      nextCursor: act-1
- id: MCP-10
  description: Handles empty result set
  category: mcp-tools
  status: implemented
  priority: P1
  when: mcp_jules_session_timeline
  given:
    sessionId: session-pqr
    args: {}
    activities: []
  then:
    result:
      activities:
        count: 0
      hasMore: false
      nextCursor: null
- id: MCP-12
  description: Timeline returns lightweight activities with message and artifacts
  category: mcp-tools
  status: implemented
  priority: P0
  when: mcp_jules_session_timeline
  given:
    sessionId: session-light
    args:
      limit: 1
    activities:
      - id: act-1
        type: agentMessaged
        message: 'This is a very long message that should be truncated in the summary. This is a very long message that should be truncated in the summary. This is a very long message that should be truncated in the summary. This is a very long message that should be truncated in the summary.'
        artifacts:
          - type: file
            path: src/index.ts
  then:
    result:
      activities:
        count: 1
        items:
          - id: act-1
            # Summary remains truncated for backward compatibility
            summary: 'This is a very long message that should be truncated in the summary. This is a very long message that should be truncated in the summary. This is a very long message that should be truncated in the su...'
            # Full message is now included
            hasMessage: true
            # Artifacts are now included by default
            hasArtifacts: true
            artifactCount: 1
      hasMore: false

# jules_get_code_changes tests
- id: MCP-20
  description: Returns empty changes for session with no changeSet artifacts
  category: mcp-tools
  status: implemented
  priority: P0
  when: mcp_jules_get_code_changes
  given:
    sessionId: session-no-changes
    activities:
      - id: act-1
        type: agentMessaged
        message: Hello
        artifacts: []
  then:
    result:
      sessionId: session-no-changes
      changes:
        count: 0
      summary:
        totalFiles: 0
        created: 0
        modified: 0
        deleted: 0

- id: MCP-21
  description: Returns parsed code changes for modified file
  category: mcp-tools
  status: implemented
  priority: P0
  when: mcp_jules_get_code_changes
  given:
    sessionId: session-modified
    activities:
      - id: act-1
        type: progressUpdated
        createTime: '2026-01-05T20:45:00Z'
        artifacts:
          - type: changeSet
            source: agent
            gitPatch:
              unidiffPatch: |
                diff --git a/src/index.ts b/src/index.ts
                index abc123..def456 100644
                --- a/src/index.ts
                +++ b/src/index.ts
                @@ -1,2 +1,3 @@
                 const a = 1;
                +const b = 2;
                 export { a };
  then:
    result:
      sessionId: session-modified
      changes:
        count: 1
        items:
          - path: src/index.ts
            changeType: modified
            artifactId: act-1
            additions: 1
            deletions: 0
      summary:
        totalFiles: 1
        created: 0
        modified: 1
        deleted: 0

- id: MCP-22
  description: Returns parsed code changes for created file
  category: mcp-tools
  status: implemented
  priority: P1
  when: mcp_jules_get_code_changes
  given:
    sessionId: session-created
    activities:
      - id: act-2
        type: progressUpdated
        createTime: '2026-01-05T20:46:00Z'
        artifacts:
          - type: changeSet
            source: agent
            gitPatch:
              unidiffPatch: |
                diff --git a/src/new.ts b/src/new.ts
                new file mode 100644
                --- /dev/null
                +++ b/src/new.ts
                @@ -0,0 +1,2 @@
                +export const x = 1;
                +export const y = 2;
  then:
    result:
      sessionId: session-created
      changes:
        count: 1
        items:
          - path: src/new.ts
            changeType: created
            additions: 2
            deletions: 0
      summary:
        totalFiles: 1
        created: 1
        modified: 0
        deleted: 0

- id: MCP-23
  description: Returns parsed code changes for deleted file
  category: mcp-tools
  status: implemented
  priority: P1
  when: mcp_jules_get_code_changes
  given:
    sessionId: session-deleted
    activities:
      - id: act-3
        type: progressUpdated
        createTime: '2026-01-05T20:47:00Z'
        artifacts:
          - type: changeSet
            source: agent
            gitPatch:
              unidiffPatch: |
                diff --git a/src/old.ts b/src/old.ts
                deleted file mode 100644
                --- a/src/old.ts
                +++ /dev/null
                @@ -1,3 +0,0 @@
                -const old = 1;
                -const legacy = 2;
                -export { old };
  then:
    result:
      sessionId: session-deleted
      changes:
        count: 1
        items:
          - path: src/old.ts
            changeType: deleted
            additions: 0
            deletions: 3
      summary:
        totalFiles: 1
        created: 0
        modified: 0
        deleted: 1

- id: MCP-24
  description: Aggregates multiple file changes across activities
  category: mcp-tools
  status: implemented
  priority: P0
  when: mcp_jules_get_code_changes
  given:
    sessionId: session-multi
    activities:
      - id: act-1
        type: progressUpdated
        createTime: '2026-01-05T20:40:00Z'
        artifacts:
          - type: changeSet
            source: agent
            gitPatch:
              unidiffPatch: |
                diff --git a/src/a.ts b/src/a.ts
                --- a/src/a.ts
                +++ b/src/a.ts
                @@ -1 +1,2 @@
                 const a = 1;
                +const aa = 2;
      - id: act-2
        type: progressUpdated
        createTime: '2026-01-05T20:45:00Z'
        artifacts:
          - type: changeSet
            source: agent
            gitPatch:
              unidiffPatch: |
                diff --git a/src/b.ts b/src/b.ts
                new file mode 100644
                --- /dev/null
                +++ b/src/b.ts
                @@ -0,0 +1 @@
                +export const b = 1;
  then:
    result:
      sessionId: session-multi
      changes:
        count: 2
      summary:
        totalFiles: 2
        created: 1
        modified: 1
        deleted: 0
