# .github/workflows/ci.yml
name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Prevents multiple runs on the same PR from overlapping
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to see commit history and changed files

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # 1. Get Changed Files for Jules context
      - name: Get Changed Files
        id: changed-files
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ' ')
          echo "list=$FILES" >> $GITHUB_OUTPUT

      # 2. Verify Attribution (Dynamic Co-authored-by check)
      - name: Verify Attribution
        id: attribution
        env:
          USER_NAME: ${{ github.event.pull_request.user.login }}
          USER_ID: ${{ github.event.pull_request.user.id }}
        run: |
          # Use HEAD SHA to check the actual commit, not the merge commit
          COMMIT_MSG=$(git show -s --format=%B ${{ github.event.pull_request.head.sha }})
          EXPECTED="Co-authored-by: $USER_NAME <$USER_ID+$USER_NAME@users.noreply.github.com>"

          if [[ ! "$COMMIT_MSG" == *"$EXPECTED"* ]]; then
            echo "log=Missing attribution. Please append this to your commit message: $EXPECTED" >> $GITHUB_OUTPUT
            exit 1
          fi

      # 3. Quality Checks (Each captures errors into GITHUB_OUTPUT)
      - name: Check Formatting
        id: format
        run: |
          npm run format:check || (echo "log=$(echo 'Formatting/Linting failed. Run npm run format.' | base64 -w 0)" >> $GITHUB_OUTPUT && exit 1)

      - name: Type Check
        id: types
        run: |
          npm run type-check > ts_error.txt 2>&1 || (echo "log=$(head -n 15 ts_error.txt | base64 -w 0)" >> $GITHUB_OUTPUT && exit 1)

      - name: Run Tests
        id: tests
        run: |
          npm test > test_log.txt 2>&1 || (echo "log=$(tail -n 20 test_log.txt | base64 -w 0)" >> $GITHUB_OUTPUT && exit 1)

      - name: Production Build
        run: npm run build

      - name: Smoke Test
        id: smoke
        run: |
          npm run test:smoke > smoke_log.txt 2>&1 || (echo "log=$(tail -n 20 smoke_log.txt | base64 -w 0)" >> $GITHUB_OUTPUT && exit 1)

      # 4. Report Failures to Jules via modjules
      - name: Report Failure to Jules
        if: failure()
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          BRANCH_NAME: ${{ github.head_ref }}
          FILES_CHANGED: ${{ steps.changed-files.outputs.list }}
          # Determine the error type based on which step produced output
          ERROR_TYPE: ${{ steps.attribution.outputs.log && 'Attribution Check' || steps.format.outputs.log && 'Formatting Failure' || steps.types.outputs.log && 'TypeScript Error' || steps.tests.outputs.log && 'Test Failure' || steps.smoke.outputs.log && 'Smoke Test Failure' || 'Quality Gate Failure' }}
          # Pass the log as a base64 string to prevent shell character issues
          # Note: ATTR_LOG is plain text, others are base64 encoded. The script expects base64.
          # We need to ensure uniformity.
          # The shell logic below handles the discrepancy.
          ATTR_LOG: ${{ steps.attribution.outputs.log }}
          OTHER_LOGS: ${{ steps.types.outputs.log || steps.tests.outputs.log || steps.smoke.outputs.log || steps.format.outputs.log }}
        run: |
          if [ -n "$ATTR_LOG" ]; then
             # Encode plain text attribution log to base64 for consistency
             export ERROR_LOG=$(echo -n "$ATTR_LOG" | base64 -w 0)
          else
             export ERROR_LOG="$OTHER_LOGS"
          fi

          npm run ci:report
