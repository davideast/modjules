name: CI

on:
  pull_request:
    # Runs when a PR is opened or a new commit is pushed to it
    types: [opened, synchronize]
    branches:
      - main

# Grant permissions for the job to post comments on the PR
permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: 1. Find or Create Jules Session
        id: find_or_create_session
        uses: actions/github-script@v7
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        with:
          # This token is automatically provided by GitHub
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string # Ensures the 'session_name' output is a clean string
          script: |
            const markerRegex = /Jules-Session: (sessions\/[a-zA-Z0-9-]+)/;
            const prNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            // 1. Find existing session by reading PR comments
            console.log(`Checking for existing Jules session in PR #${prNumber}...`);
            const { data: comments } = await github.rest.issues.listComments({
              owner, repo, issue_number: prNumber,
            });

            // Loop backwards (most recent first) to find the session
            for (const comment of comments.slice().reverse()) {
              const match = comment.body.match(markerRegex);
              if (match && match[1]) {
                console.log(`Found existing session: ${match[1]}`);
                return match[1]; // This becomes the step's output
              }
            }
            // 2. Not found, so create a new session
            console.log('No session found. Creating a new one...');
            const prTitle = context.payload.pull_request.title;
            const createPayload = {
              title: `CI Check for PR #${prNumber}: ${prTitle}`,
              prompt: `A CI run has started for PR #${prNumber} ("${prTitle}"). I will report back if there are any failures.`
            };
            const response = await fetch('https://jules.googleapis.com/v1alpha/sessions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.JULES_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(createPayload)
            });
            if (!response.ok) {
              const errorText = await response.text();
              core.setFailed(`Failed to create Jules session: ${response.status} ${errorText}`);
              return;
            }
            const sessionData = await response.json();
            const newSessionName = sessionData.name;
            if (!newSessionName) {
              core.setFailed('Jules API response did not contain a session name.');
              return;
            }
            console.log(`Successfully created session: ${newSessionName}`);

            // 3. Post the new session ID as a comment for future runs
            const commentBody = `Jules-Session: ${newSessionName}`;
            await github.rest.issues.createComment({
              owner, repo, issue_number: prNumber,
              body: commentBody
            });
            console.log(`Posted new session ID to PR.`);
            // 4. Return the new session name as the step's output
            return newSessionName;

      - name: 2. Run type check
        id: type_check
        run: npm run type-check &> type-check-logs.txt
        continue-on-error: true

      - name: 3. Run tests
        id: run_tests
        run: npm test &> test-logs.txt
        continue-on-error: true

      - name: 4. Send failure logs to Jules
        # if: failure() is a simple check that runs if any previous step failed
        if: failure()
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          SESSION_NAME: ${{ steps.find_or_create_session.outputs.result }}
        run: |
          echo "CI failed. Preparing to send failure message to ${SESSION_NAME}..."

          # Combine logs from all failing steps
          TYPE_CHECK_LOGS="No type-check errors."
          TEST_LOGS="No test errors."
          if [ -s type-check-logs.txt ]; then
            TYPE_CHECK_LOGS=$(cat type-check-logs.txt)
          fi
          if [ -s test-logs.txt ]; then
            TEST_LOGS=$(cat test-logs.txt)
          fi
          FULL_LOGS="The CI build for my PR failed.
          --- TYPE CHECK LOGS ---
          ${TYPE_CHECK_LOGS}

          --- TEST LOGS ---
          ${TEST_LOGS}"

          # Build the JSON payload for the sendMessage endpoint
          JSON_PAYLOAD=$(jq -n \
            --arg logs "$FULL_LOGS" \
            '{ "message": { "text": $logs } }')

          curl -X POST "https://jules.googleapis.com/v1alpha/${SESSION_NAME}:sendMessage" \
            -H "Authorization: Bearer ${JULES_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "${JSON_PAYLOAD}"
