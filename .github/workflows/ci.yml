# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]

# Prevents multiple runs on the same PR from overlapping
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to see commit history and changed files

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # 1. Get Changed Files for Jules context
      - name: Get Changed Files
        id: changed-files
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ' ')
          echo "list=$FILES" >> $GITHUB_OUTPUT

      # 2. Quality Checks (Each captures errors into GITHUB_OUTPUT)
      - name: Check Formatting
        id: format
        continue-on-error: true
        run: |
          npm run format:check || (echo "log=$(echo 'Formatting/Linting failed. Run npm run format.' | base64 -w 0)" >> $GITHUB_OUTPUT && exit 1)

      - name: Type Check
        id: types
        continue-on-error: true
        run: |
          npm run type-check > ts_error.txt 2>&1 || (echo "log=$(head -n 15 ts_error.txt | base64 -w 0)" >> $GITHUB_OUTPUT && exit 1)

      - name: Run Tests
        id: tests
        continue-on-error: true
        run: |
          npm test > test_log.txt 2>&1 || (echo "log=$(tail -n 20 test_log.txt | base64 -w 0)" >> $GITHUB_OUTPUT && exit 1)

      - name: Production Build
        id: build
        continue-on-error: true
        run: |
          npm run build > build_log.txt 2>&1 || (echo "log=$(tail -n 20 build_log.txt | base64 -w 0)" >> $GITHUB_OUTPUT && exit 1)

      - name: Smoke Test
        id: smoke
        continue-on-error: true
        run: |
          npm run test:smoke > smoke_log.txt 2>&1 || (echo "log=$(tail -n 20 smoke_log.txt | base64 -w 0)" >> $GITHUB_OUTPUT && exit 1)

      # 3. Verify Attribution (Dynamic Co-authored-by check) - MOVED TO LAST
      - name: Verify Attribution
        if: github.event_name == 'pull_request'
        id: attribution
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_USER_LOGIN: ${{ github.event.pull_request.user.login }}
          PR_USER_ID: ${{ github.event.pull_request.user.id }}
        run: |
          # Use HEAD SHA to check the actual commit, not the merge commit
          export COMMIT_MSG=$(git show -s --format=%B ${{ github.event.pull_request.head.sha }})
          npx tsx scripts/verify-attribution.ts

      # 4. Report Failures to Jules via modjules
      - name: Report Failure to Jules
        if: always() && github.event_name == 'pull_request' && (github.event.pull_request.user.login == 'google-labs-jules' || endsWith(github.event.pull_request.user.login, '[bot]'))
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          BRANCH_NAME: ${{ github.head_ref }}
          FILES_CHANGED: ${{ steps.changed-files.outputs.list }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_USER_LOGIN: ${{ github.event.pull_request.user.login }}
          PR_USER_ID: ${{ github.event.pull_request.user.id }}

          # Pass raw outputs to shell for correct logic handling
          ATTR_LOG: ${{ steps.attribution.outputs.log }}
          FORMAT_LOG: ${{ steps.format.outputs.log }}
          TYPE_LOG: ${{ steps.types.outputs.log }}
          TEST_LOG: ${{ steps.tests.outputs.log }}
          BUILD_LOG: ${{ steps.build.outputs.log }}
          SMOKE_LOG: ${{ steps.smoke.outputs.log }}
        run: |
          # Collect ALL failures into a combined report
          ERROR_TYPES=""
          ERROR_LOGS=""

          if [ -n "$FORMAT_LOG" ]; then
            ERROR_TYPES="${ERROR_TYPES}Formatting Failure\n"
            ERROR_LOGS="${ERROR_LOGS}--- Formatting ---\n$(echo "$FORMAT_LOG" | base64 -d)\n\n"
          fi

          if [ -n "$TYPE_LOG" ]; then
            ERROR_TYPES="${ERROR_TYPES}TypeScript Error\n"
            ERROR_LOGS="${ERROR_LOGS}--- TypeScript ---\n$(echo "$TYPE_LOG" | base64 -d)\n\n"
          fi

          if [ -n "$TEST_LOG" ]; then
            ERROR_TYPES="${ERROR_TYPES}Test Failure\n"
            ERROR_LOGS="${ERROR_LOGS}--- Tests ---\n$(echo "$TEST_LOG" | base64 -d)\n\n"
          fi

          if [ -n "$BUILD_LOG" ]; then
            ERROR_TYPES="${ERROR_TYPES}Build Failure\n"
            ERROR_LOGS="${ERROR_LOGS}--- Build ---\n$(echo "$BUILD_LOG" | base64 -d)\n\n"
          fi

          if [ -n "$SMOKE_LOG" ]; then
            ERROR_TYPES="${ERROR_TYPES}Smoke Test Failure\n"
            ERROR_LOGS="${ERROR_LOGS}--- Smoke Test ---\n$(echo "$SMOKE_LOG" | base64 -d)\n\n"
          fi

          if [ -n "$ATTR_LOG" ]; then
            ERROR_TYPES="${ERROR_TYPES}Attribution Check\n"
            ERROR_LOGS="${ERROR_LOGS}--- Attribution ---\n$(echo "$ATTR_LOG" | base64 -d)\n\n"
          fi

          # No errors detected
          if [ -z "$ERROR_TYPES" ]; then
            echo "No failures detected. Skipping report."
            exit 0
          fi

          # Export combined errors for the reporting script
          export ERROR_TYPE=$(echo -e "$ERROR_TYPES" | tr '\n' ', ' | sed 's/, $//')
          export ERROR_LOG_B64=$(echo -e "$ERROR_LOGS" | base64 -w 0)

          # Run the reporting script
          npx tsx scripts/ci-report.ts

      - name: Fail Job if Errors
        if: always()
        run: |
          if [ -n "${{ steps.format.outputs.log }}" ] || [ -n "${{ steps.types.outputs.log }}" ] || [ -n "${{ steps.tests.outputs.log }}" ] || [ -n "${{ steps.build.outputs.log }}" ] || [ -n "${{ steps.smoke.outputs.log }}" ] || [ -n "${{ steps.attribution.outputs.log }}" ]; then
            echo "One or more checks failed."
            exit 1
          fi
