## Efficient Queries Spec
##
## Behavior: "I need to efficiently query large datasets"
##
## These specs define performance expectations for common query patterns.
## Large datasets should not cause linear-time operations for simple queries.

# =============================================================================
# COUNT OPERATIONS
# =============================================================================

- id: EFF-01
  description: Get activity count without full scan
  category: count
  status: implemented
  testedIn: tests/efficient-queries/spec.test.ts
  priority: P0
  given:
    sessionId: 'sess-large'
    cachedActivities: 1000
  when: getActivityCount
  then:
    result: 1000
    performance:
      fullScanRequired: false

- id: EFF-02
  description: Get session count without full scan
  category: count
  status: pending
  priority: P1
  given:
    cachedSessions: 500
  when: getSessionCount
  then:
    result: 500
    performance:
      fullScanRequired: false

# =============================================================================
# LATEST N QUERIES
# =============================================================================

- id: EFF-03
  description: Get latest N activities returns newest first
  category: latest
  status: pending
  priority: P0
  given:
    sessionId: 'sess-ordered'
    activities:
      - id: 'act-old'
        createTime: '2024-01-01T00:00:00Z'
      - id: 'act-mid'
        createTime: '2024-01-02T00:00:00Z'
      - id: 'act-new'
        createTime: '2024-01-03T00:00:00Z'
  when: getLatestActivities(2)
  then:
    result:
      - id: 'act-new'
      - id: 'act-mid'

- id: EFF-04
  description: Get latest N is efficient for large datasets
  category: latest
  status: pending
  priority: P0
  given:
    sessionId: 'sess-huge'
    cachedActivities: 10000
  when: getLatestActivities(10)
  then:
    resultCount: 10
    performance:
      fullScanRequired: false

# =============================================================================
# DEFAULT ORDERING
# =============================================================================

- id: EFF-05
  description: Default query order is newest first
  category: ordering
  status: pending
  priority: P0
  given:
    sessionId: 'sess-default-order'
    activities:
      - id: 'act-1'
        createTime: '2024-01-01T00:00:00Z'
      - id: 'act-2'
        createTime: '2024-01-02T00:00:00Z'
  when: select
  then:
    firstResultId: 'act-2'
    lastResultId: 'act-1'

- id: EFF-06
  description: Ascending order can be explicitly requested
  category: ordering
  status: pending
  priority: P1
  given:
    sessionId: 'sess-asc'
    activities:
      - id: 'act-1'
        createTime: '2024-01-01T00:00:00Z'
      - id: 'act-2'
        createTime: '2024-01-02T00:00:00Z'
    options:
      order: 'asc'
  when: select
  then:
    firstResultId: 'act-1'
    lastResultId: 'act-2'

# =============================================================================
# DEFAULT LIMITS
# =============================================================================

- id: EFF-07
  description: Default limit prevents unbounded results
  category: limits
  status: implemented
  testedIn: tests/query/select.test.ts
  priority: P0
  given:
    sessionId: 'sess-unlimited'
    cachedActivities: 1000
  when: select
  then:
    resultCount:
      max: 100

- id: EFF-08
  description: Custom limit overrides default
  category: limits
  status: implemented
  testedIn: tests/query/select.test.ts
  priority: P0
  given:
    sessionId: 'sess-custom-limit'
    cachedActivities: 1000
    options:
      limit: 25
  when: select
  then:
    resultCount: 25

# =============================================================================
# CURSOR PAGINATION
# =============================================================================

- id: EFF-09
  description: Cursor-based pagination with after
  category: pagination
  status: implemented
  testedIn: tests/activities/client.test.ts
  priority: P1
  given:
    sessionId: 'sess-cursor'
    activities:
      - id: 'act-1'
      - id: 'act-2'
      - id: 'act-3'
      - id: 'act-4'
    options:
      after: 'act-2'
      limit: 2
  when: select
  then:
    resultIds: ['act-3', 'act-4']

- id: EFF-10
  description: Cursor-based pagination with before
  category: pagination
  status: implemented
  testedIn: tests/activities/client.test.ts
  priority: P1
  given:
    sessionId: 'sess-cursor-before'
    activities:
      - id: 'act-1'
      - id: 'act-2'
      - id: 'act-3'
      - id: 'act-4'
    options:
      before: 'act-3'
      limit: 2
  when: select
  then:
    resultIds: ['act-1', 'act-2']
