## GitHub Integration Spec Test Cases
##
## This file contains machine-readable test case definitions for GitHub integration.
## The test runner consumes this file for spec-driven testing.
##
## Structure:
##   - Each test case has: id, description, category, status, priority, given, when, then
##   - Status: implemented | pending | skipped
##   - Priority: P0 (critical) | P1 (important) | P2 (nice-to-have)

# =============================================================================
# GITHUB ADAPTER
# =============================================================================

- id: GH-01
  description: GitHub factory creates adapter with config
  category: adapter
  status: implemented
  priority: P0
  when:
    action: 'adapter.create'
  then:
    result:
      isAdapter: true

- id: GH-02
  description: pr(repo, number) returns PRClient
  category: adapter
  status: implemented
  priority: P0
  when:
    action: 'adapter.pr'
    params:
      repo: 'owner/repo'
      number: 123
  then:
    result:
      owner: 'owner'
      repo: 'repo'
      number: 123

- id: GH-03
  description: pr(url) parses GitHub PR URL
  category: adapter
  status: implemented
  priority: P0
  when:
    action: 'adapter.pr'
    params:
      url: 'https://github.com/owner/repo/pull/123'
  then:
    result:
      owner: 'owner'
      repo: 'repo'
      number: 123

- id: GH-05
  description: parsePrUrl extracts components from valid URL
  category: adapter
  status: implemented
  priority: P0
  when:
    action: 'adapter.parsePrUrl'
    params:
      url: 'https://github.com/my-org/my-repo/pull/42'
  then:
    result:
      owner: 'my-org'
      repo: 'my-repo'
      number: 42

- id: GH-06
  description: parsePrUrl returns null for invalid URL
  category: adapter
  status: implemented
  priority: P1
  when:
    action: 'adapter.parsePrUrl'
    params:
      url: 'https://github.com/owner/repo'
  then:
    result: null

- id: GH-07
  description: viewer returns authenticated user
  category: adapter
  status: implemented
  priority: P1
  given:
    api_responses:
      - endpoint: '/user'
        status_code: 200
        body:
          id: 12345
          login: 'testuser'
          type: 'User'
          avatar_url: 'http://example.com/avatar.png'
  when:
    action: 'adapter.viewer'
  then:
    result:
      id: 12345
      login: 'testuser'
      type: 'User'
      avatarUrl: 'http://example.com/avatar.png'
    api_calls:
      expected_count: 1
      endpoints: ['/user']

- id: GH-08
  description: rateLimit returns current rate limit status
  category: adapter
  status: implemented
  priority: P1
  given:
    api_responses:
      - endpoint: '/rate_limit'
        status_code: 200
        body:
          rate:
            limit: 5000
            remaining: 4999
            used: 1
            reset: 1704067200
  when:
    action: 'adapter.rateLimit'
  then:
    result:
      limit: 5000
      remaining: 4999
      used: 1
      reset: '2024-01-01T00:00:00.000Z'
    api_calls:
      expected_count: 1
      endpoints: ['/rate_limit']

# =============================================================================
# PR CLIENT - CORE OPERATIONS
# =============================================================================

- id: PR-01
  description: info() returns PRResource with all metadata
  category: pr_client
  status: implemented
  priority: P0
  given:
    api_responses:
      - endpoint: '/repos/owner/repo/pulls/123'
        status_code: 200
        body:
          id: 999
          number: 123
          node_id: 'PR_NODE_ID'
          html_url: 'https://github.com/owner/repo/pull/123'
          url: 'https://api.github.com/repos/owner/repo/pulls/123'
          title: 'Fix bug'
          body: 'This PR fixes a critical bug.'
          state: 'open'
          merged: false
          draft: false
          mergeable: true
          mergeable_state: 'clean'
          base: { ref: 'main', sha: 'base-sha' }
          head: { ref: 'fix-branch', sha: 'head-sha' }
          additions: 10
          deletions: 2
          changed_files: 1
          commits: 1
          user: { id: 1, login: 'test-user', type: 'User', avatar_url: 'avatar-url' }
          assignees: []
          created_at: '2023-01-01T10:00:00Z'
          updated_at: '2023-01-01T11:00:00Z'
          merged_at: null
          closed_at: null
  when:
    action: 'pr.info'
    params: { owner: 'owner', repo: 'repo', number: 123 }
  then:
    result:
      id: 999
      number: 123
      nodeId: 'PR_NODE_ID'
      url: 'https://github.com/owner/repo/pull/123'
      apiUrl: 'https://api.github.com/repos/owner/repo/pulls/123'
      title: 'Fix bug'
      body: 'This PR fixes a critical bug.'
      state: 'open'
      merged: false
      draft: false
      mergeable: true
      mergeableState: 'clean'
      baseRef: 'main'
      headRef: 'fix-branch'
      baseCommitSha: 'base-sha'
      headCommitSha: 'head-sha'
      additions: 10
      deletions: 2
      changedFiles: 1
      commits: 1
      author: { id: 1, login: 'test-user', type: 'User', avatarUrl: 'avatar-url' }
      assignees: []
      createdAt: '2023-01-01T10:00:00.000Z'
      updatedAt: '2023-01-01T11:00:00.000Z'
      mergedAt: null
      closedAt: null
    api_calls:
      expected_count: 1

- id: PR-02
  description: info() uses read-through caching and avoids network call
  category: pr_client
  status: implemented
  priority: P0
  given:
    system_time: '2023-01-01T12:00:20Z' # 20 seconds after sync
    time_elapsed_ms: 10000 # 10 seconds pass between calls
    api_responses:
      - endpoint: '/repos/owner/repo/pulls/123'
        status_code: 200
        body: { id: 999, state: 'open', created_at: '2023-01-01T10:00:00Z', updated_at: '2023-01-01T11:00:00Z' }
  when:
    action: 'pr.info'
    params: { owner: 'owner', repo: 'repo', number: 123 }
    calls: 2 # Call info() twice
  then:
    api_calls:
      expected_count: 1 # Only one network call should be made

# =============================================================================
# CACHING
# =============================================================================

- id: CAC-01
  description: HOT Cache - Open PRs cache is valid if called within 30 seconds
  category: caching
  status: implemented
  priority: P0
  given:
    system_time: '2023-01-01T12:00:00Z'
    time_elapsed_ms: 25000 # 25 seconds
    api_responses:
      - endpoint: '/repos/owner/repo/pulls/1'
        status_code: 200
        body: { id: 1, state: 'open', created_at: '2023-01-01T10:00:00Z', updated_at: '2023-01-01T11:00:00Z' }
  when:
    action: 'pr.info'
    params: { owner: 'owner', repo: 'repo', number: 1 }
    calls: 2
  then:
    api_calls:
      expected_count: 1

- id: CAC-01b
  description: HOT Cache - Open PRs cache is invalid if called after 30 seconds
  category: caching
  status: implemented
  priority: P0
  given:
    system_time: '2023-01-01T12:00:00Z'
    time_elapsed_ms: 35000 # 35 seconds
    api_responses:
      - endpoint: '/repos/owner/repo/pulls/1'
        status_code: 200
        body: { id: 1, state: 'open', created_at: '2023-01-01T10:00:00Z', updated_at: '2023-01-01T11:00:00Z' }
      - endpoint: '/repos/owner/repo/pulls/1'
        status_code: 200
        body: { id: 1, state: 'open', title: 'Updated', created_at: '2023-01-01T10:00:00Z', updated_at: '2023-01-01T11:00:00Z' }
  when:
    action: 'pr.info'
    params: { owner: 'owner', repo: 'repo', number: 1 }
    calls: 2
  then:
    api_calls:
      expected_count: 2

- id: CAC-03
  description: FROZEN Cache - Merged PRs older than 24h never expire
  category: caching
  status: implemented
  priority: P0
  given:
    system_time: '2024-01-10T12:00:00Z'
    time_elapsed_ms: 86400000 # 1 day
    api_responses:
      - endpoint: '/repos/owner/repo/pulls/1'
        status_code: 200
        body:
          id: 1
          state: 'closed'
          merged: true
          merged_at: '2024-01-08T10:00:00Z' # 2 days ago
          created_at: '2024-01-08T09:00:00Z'
          updated_at: '2024-01-08T09:30:00Z'
  when:
    action: 'pr.info'
    params: { owner: 'owner', repo: 'repo', number: 1 }
    calls: 2
  then:
    api_calls:
      expected_count: 1

# =============================================================================
# ERROR HANDLING
# =============================================================================

- id: ERR-01
  description: 404 response throws GitHubNotFoundError
  category: errors
  status: implemented
  priority: P0
  given:
    api_responses:
      - endpoint: '/repos/owner/repo/pulls/999'
        status_code: 404
        body: { message: 'Not Found' }
  when:
    action: 'pr.info'
    params: { owner: 'owner', repo: 'repo', number: 999 }
  then:
    error:
      type: 'GitHubNotFoundError'
      message: 'GitHub resource not found: /repos/owner/repo/pulls/999'

- id: ERR-02
  description: 401 response throws GitHubAuthError
  category: errors
  status: implemented
  priority: P0
  given:
    api_responses:
      - endpoint: '/user'
        status_code: 401
        body: { message: 'Bad credentials' }
  when:
    action: 'adapter.viewer'
  then:
    error:
      type: 'GitHubAuthError'
      message: 'Bad credentials'

- id: ERR-06
  description: 429 response throws GitHubRateLimitError with reset time
  category: errors
  status: implemented
  priority: P0
  given:
    api_responses:
      - endpoint: '/repos/owner/repo/pulls/123'
        status_code: 429
        headers:
          x-ratelimit-limit: '5000'
          x-ratelimit-remaining: '0'
          x-ratelimit-reset: '1704067200'
        body: { message: 'API rate limit exceeded' }
  when:
    action: 'pr.info'
    params: { owner: 'owner', repo: 'repo', number: 123 }
  then:
    error:
      type: 'GitHubRateLimitError'
      message: 'GitHub rate limit exceeded. Resets at 2024-01-01T00:00:00.000Z'

# =============================================================================
# AUTHENTICATION (PAT only)
# =============================================================================

- id: AUTH-02
  description: 401 response throws GitHubAuthError
  category: auth
  status: implemented
  priority: P0
  given:
    api_responses:
      - endpoint: '/user'
        status_code: 401
        body: { message: 'Bad credentials' }
  when:
    action: 'adapter.viewer'
  then:
    error:
      type: 'GitHubAuthError'
      status: 401

- id: AUTH-03
  description: Token is never logged or exposed in errors
  category: auth
  status: implemented
  priority: P0
  given:
    api_responses:
      - endpoint: '/user'
        status_code: 401
        body: { message: 'Bad credentials' }
  when:
    action: 'adapter.viewer'
  then:
    error:
      type: 'GitHubAuthError'
      messageNotContains: 'ghp_secret_token_xxx'
