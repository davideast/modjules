---
// Server-Side Frontmatter
const firebaseConfig = {
  apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
  authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
};
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Modjules + Firebase Proxy</title>
    <style>
      :root { --bg: #0f172a; --text: #f8fafc; --primary: #3b82f6; --error: #ef4444; }
      body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; padding: 2rem; max-width: 800px; margin-left: auto; margin-right: auto; }
      .card { background: #1e293b; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid #334155; }
      button { background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; font-weight: bold; }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      pre { background: #000; padding: 1rem; overflow-x: auto; border-radius: 0.25rem; font-size: 0.85rem; color: #4ade80; }
      .hidden { display: none; }
    </style>
  </head>
  <body>
    <h1>Modjules Proxy Example</h1>

    <div class="card" id="auth-section">
      <h2>1. Authentication</h2>
      <p>Sign in to obtain a secure Firebase ID Token.</p>
      <button id="login-btn">Sign In with Google</button>
      <div id="user-info" class="hidden">
        <p>Logged in as: <strong id="user-email"></strong></p>
        <button id="logout-btn" style="background: var(--error)">Sign Out</button>
      </div>
    </div>

    <div class="card hidden" id="action-section">
      <h2>2. Proxy Request</h2>
      <p>Send a secure handshake to <code>/api/jules</code>.</p>
      <button id="start-session-btn">Start Session</button>

      <h3>Logs</h3>
      <pre id="logs">Waiting for action...</pre>
    </div>

    <script define:vars={{ firebaseConfig }}>
      import { initializeApp } from "firebase/app";
      import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "firebase/auth";
      import { jules } from "modjules";

      // 1. Initialize Firebase Client
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      // UI References
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const startSessionBtn = document.getElementById('start-session-btn');
      const userInfo = document.getElementById('user-info');
      const userEmail = document.getElementById('user-email');
      const authSection = document.getElementById('auth-section');
      const actionSection = document.getElementById('action-section');
      const logs = document.getElementById('logs');

      let currentToken = null;

      function log(msg) {
        logs.textContent = `> ${msg}\n` + logs.textContent;
      }

      // 2. Auth Handlers
      loginBtn.addEventListener('click', async () => {
        try { await signInWithPopup(auth, provider); }
        catch (e) { log(`Auth Error: ${e.message}`); }
      });

      logoutBtn.addEventListener('click', () => signOut(auth));

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userEmail.textContent = user.email;
          userInfo.classList.remove('hidden');
          loginBtn.classList.add('hidden');
          actionSection.classList.remove('hidden');

          // Get the ID Token (JWT)
          currentToken = await user.getIdToken();
          log(`Authenticated. Token acquired.`);
        } else {
          userInfo.classList.add('hidden');
          loginBtn.classList.remove('hidden');
          actionSection.classList.add('hidden');
          currentToken = null;
          log('Signed out.');
        }
      });

      // 3. Modjules Integration
      startSessionBtn.addEventListener('click', async () => {
        if (!currentToken) return log('Error: No token available.');

        log('Initializing Jules Client...');

        // Initialize pointing to our LOCAL Astro proxy
        // The token is passed in the header automatically by the client
        const client = jules({
          baseUrl: '/api/jules',
          authToken: currentToken,
        });

        try {
          log('Sending Handshake to Proxy...');
          const session = await client.createSession({
            model: 'jules-2025',
            messages: [{ role: 'user', content: 'Hello via Proxy!' }]
          });

          log(`✅ Success! Session Created: ${session.id}`);
        } catch (err) {
          log(`❌ Proxy Error: ${err.message}`);
          console.error(err);
        }
      });
    </script>
  </body>
</html>
